# 掘金文章发布测试

这个测试套件用于测试掘金文章发布功能，包括本地图片上传、内容替换和文章保存。

## 测试用例

### 1. 发布包含本地图片的文章 (`发布包含本地图片的文章`)

这个测试用例会：

1. **解析 Markdown 文件**：读取测试文章并提取元数据和本地图片
2. **上传本地图片**：将文章中的本地图片逐个上传到掘金
3. **替换图片地址**：将原内容中的本地图片路径替换为掘金图片URL
4. **清空编辑器**：清除编辑器中的临时内容
5. **粘贴新内容**：将更新后的内容（包含掘金图片地址）粘贴到编辑器
6. **保存草稿**：保存文章到掘金草稿箱

### 2. 发布纯文本文章 (`发布纯文本文章`)

这个测试用例用于测试不包含图片的文章发布流程，验证基本的发布功能。

## 测试文件

- `fixtures/test-article.md` - 基础测试文章（不包含图片）
- `fixtures/test-article-with-images.md` - 包含本地图片引用的测试文章

## 运行测试

### 前置条件

1. 确保已安装依赖：
   ```bash
   npm install
   ```

2. 确保有有效的掘金登录状态（`juejin-storage-state.json`）

3. 如果要测试图片上传，确保测试文章中的图片路径指向实际存在的图片文件

### 运行所有测试

```bash
npm test
```

### 运行特定测试

```bash
# 只运行图片上传测试
npx playwright test tests/juejin-publisher.spec.ts --grep "发布包含本地图片的文章"

# 只运行纯文本发布测试
npx playwright test tests/juejin-publisher.spec.ts --grep "发布纯文本文章"
```

### 调试模式运行

```bash
# 显示浏览器界面
npx playwright test tests/juejin-publisher.spec.ts --headed

# 慢速运行，便于观察
npx playwright test tests/juejin-publisher.spec.ts --headed --debug
```

## 功能特性

### 智能图片上传

- 支持多种图片格式：JPG、PNG、GIF、WebP、SVG
- 自动检测上传按钮和触发方式
- 多种上传方式：按钮点击、快捷键、拖拽
- 智能等待上传完成和状态检测

### 内容处理

- 自动解析 Markdown 元数据（标题、分类、标签）
- 本地图片路径自动替换为掘金图片URL
- 支持剪贴板操作和备用方案
- 内容验证和错误处理

### 错误处理

- 图片上传失败时的优雅降级
- 多种选择器的容错处理
- 详细的日志输出和状态提示
- 超时处理和重试机制

## 配置选项

### 环境变量

- `JUEJIN_USERNAME` - 掘金用户名/手机号
- `JUEJIN_PASSWORD` - 掘金密码
- `LOG_LEVEL` - 日志级别（默认：info）

### 测试配置

- 超时设置：图片上传 30秒，页面加载 10秒
- 等待时间：图片URL插入 3秒，内容粘贴 3秒
- 重试机制：上传失败时继续处理下一张图片

## 故障排除

### 常见问题

1. **图片上传失败**
   - 检查图片文件是否存在
   - 确认图片格式是否支持
   - 检查网络连接和掘金服务状态

2. **选择器找不到**
   - 掘金可能更新了UI，需要更新选择器
   - 使用 `--headed` 模式观察页面结构
   - 检查页面是否完全加载

3. **登录状态失效**
   - 删除 `juejin-storage-state.json` 文件
   - 重新运行登录流程
   - 检查账号密码是否正确

### 调试技巧

1. **查看详细日志**：测试运行时会输出详细的状态信息
2. **使用浏览器调试**：`--headed --debug` 模式可以观察每个步骤
3. **检查网络请求**：在浏览器开发者工具中查看图片上传的网络请求
4. **验证选择器**：使用浏览器控制台测试选择器是否正确

## 扩展功能

### 添加新的测试用例

1. 在 `test.describe` 块中添加新的 `test` 函数
2. 创建对应的测试文章文件
3. 实现特定的测试逻辑

### 自定义图片上传逻辑

可以修改图片上传部分来支持：
- 批量上传
- 图片压缩和优化
- 自定义上传参数
- 上传进度监控

### 支持更多平台

当前的架构可以扩展到其他平台：
- 微信公众号
- 知乎
- CSDN
- 简书

## 注意事项

1. **测试环境**：建议在测试环境中运行，避免影响生产内容
2. **图片大小**：掘金对图片大小有限制，建议使用适当大小的测试图片
3. **频率限制**：避免频繁运行测试，以免触发掘金的频率限制
4. **数据清理**：测试完成后建议清理测试草稿，保持账号整洁

## 贡献指南

欢迎提交 Issue 和 Pull Request 来改进这个测试套件：

1. 报告 Bug 或提出新功能建议
2. 改进错误处理和容错机制
3. 添加新的测试场景
4. 优化性能和稳定性
5. 更新文档和示例
